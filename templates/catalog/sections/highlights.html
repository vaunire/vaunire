{% load static %}

<section class="container ml-20 mx-auto font-montserrat max-w-[1325px] px-6">
    <div class="flex justify-center">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-9 w-full">

            <!-- ========================================== -->
            <!-- КОЛОНКА 1 (2/3): Слайдер                   -->
            <!-- ========================================== -->
            <div class="lg:col-span-2">
                <div class="relative overflow-hidden rounded-2xl shadow-2xl">
                    <div class="swiper slider-highlights h-[480px] bg-gray-900">

                        <div class="custom-pagination"></div>

                        <div class="swiper-wrapper">
                            {% if slides %}
                                {% for slide in slides %}
                                    <div class="swiper-slide">
                                        <div class="block relative h-full select-none bg-gray-800">
                                            
                                            {% if slide.image %}
                                                <img src="{{ slide.image.url }}" alt="Slide {{ forloop.counter }}" class="w-full h-full object-cover"/>
                                            {% else %}
                                                <div class="w-full h-full flex flex-col items-center justify-center text-gray-500 bg-gray-800">
                                                    <svg class="w-16 h-16 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                    </svg>
                                                    <span class="text-lg font-medium tracking-wide opacity-70">Нет фото</span>
                                                </div>
                                            {% endif %}

                                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>

                                            <div class="absolute bottom-0 tracking-wide left-0 right-0 p-8">
                                                <div class="flex items-end justify-between">
                                                    <div class="max-w-2xl font-montserrat tracking-wide">
                                                        <h2 class="text-2xl font-bold text-white mb-1 drop-shadow-2xl leading-tight">
                                                            {% if slide.description %}
                                                                {{ slide.description }}
                                                            {% else %}
                                                                {% if forloop.counter == 1 %}История музыки в ваших руках
                                                                {% elif forloop.counter == 2 %}Жемчужины для вашей коллекции
                                                                {% elif forloop.counter == 3 %}Эстетика аналогового звука
                                                                {% else %}Золотая коллекция CD и Винила{% endif %}
                                                            {% endif %}
                                                        </h2>
                                                        <p class="text-white/90 -mb-1 text-base font-light">
                                                            {% if forloop.first %}Соберите свою идеальную фонотеку
                                                            {% else %}Кристально чистое звучание ваших любимых хитов{% endif %}
                                                        </p>
                                                    </div>

                                                    <button onclick="window.scrollBy({top: 400, behavior: 'smooth'})" class="hidden sm:block hover:opacity-100 transition-opacity focus:outline-none cursor-pointer group">
                                                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                                                            <path d="M4 11l8 8 8-8M12 3v16"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            
                            {% else %}
                                <!-- ЗАГЛУШКА СЛАЙДЕРА -->
                                <div class="swiper-slide">
                                    <div class="block relative h-full select-none bg-gray-900">
                                        <img src="{% static 'images/placeholder_banner.jpg' %}" 
                                             onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');"
                                             alt="Music Collection" 
                                             class="w-full h-full object-cover opacity-80"/>
                                        
                                        <div class="hidden w-full h-full absolute inset-0 bg-gray-800 items-center justify-center"></div>

                                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                                        
                                        <div class="absolute bottom-0 tracking-wide left-0 right-0 p-8">
                                            <div class="flex items-end justify-between">
                                                <div class="max-w-2xl font-montserrat tracking-wide">
                                                    <h2 class="text-2xl font-bold text-white mb-1 drop-shadow-2xl leading-tight">
                                                        Добро пожаловать в Vaunire
                                                    </h2>
                                                    <p class="text-white/90 -mb-1 text-base font-light">
                                                        Лучшая коллекция винила и CD для истинных ценителей звука
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <button class="custom-prev" style="display: none;">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18L9 12L15 6"/></svg>
                        </button>
                        <button class="custom-next" style="display: none;">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18L15 12L9 6"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- КОЛОНКА 2 (1/3): Хит месяца                -->
            <!-- ========================================== -->
            <div class="h-fit group w-full max-w-[250px] mx-auto lg:mx-0 flex flex-col gap-3 lg:mt-0 pt-7">
                
                <!-- 1. Заголовок секции -->
                <div>
                    <div class="flex items-center gap-2.5">
                        <div class="relative overflow-hidden p-2 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg shadow-md shrink-0">
                            <svg class="text-white relative z-10" width="19" height="19" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
                                <path fill="currentColor" d="M528 448H112c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h416c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16m64-320c-26.5 0-48 21.5-48 48c0 7.1 1.6 13.7 4.4 19.8L476 239.2c-15.4 9.2-35.3 4-44.2-11.6L350.3 85C361 76.2 368 63 368 48c0-26.5-21.5-48-48-48s-48 21.5-48 48c0 15 7 28.2 17.7 37l-81.5 142.6c-8.9 15.6-28.9 20.8-44.2 11.6l-72.3-43.4c2.7-6 4.4-12.7 4.4-19.8c0-26.5-21.5-48-48-48S0 149.5 0 176s21.5 48 48 48c2.6 0 5.2-.4 7.7-.8L128 416h384l72.3-192.8c2.5.4 5.1.8 7.7.8c26.5 0 48-21.5 48-48s-21.5-48-48-48"/>
                            </svg>
                            <div class="absolute inset-0 z-20 block pointer-events-none">
                                <div class="w-full h-full bg-gradient-to-r from-transparent via-white/60 to-transparent -translate-x-[150%] group-hover:translate-x-[150%] transition-transform duration-700 ease-in-out skew-x-12"></div>
                            </div>
                        </div>
                        
                        <div class="font-montserrat tracking-wide">
                            <h3 class="text-lg font-bold text-gray-800 leading-tight">Хит месяца</h3>
                            <p class="text-xs text-gray-500">Самый продаваемый</p>
                        </div>
                    </div>
                </div>
                
                <!-- 2. Карточка или Заглушка -->
                {% if month_bestseller %}
                    <div class="card w-full bg-white rounded-xl tracking-wide shadow-lg overflow-hidden border border-gray-100 transition-all duration-300 hover:shadow-2xl">
                        <a href="{{ month_bestseller.get_absolute_url }}" class="block">
                            <!-- Изображение и оверлеи -->
                            <div class="relative w-full h-[230px] overflow-hidden bg-gray-100">
                                <img src="{{ month_bestseller.image.url }}" alt="{{ month_bestseller.name }}" class="w-full h-full object-cover" />
                                
                                {% if month_bestseller.offer_of_the_week %}
                                    <div class="absolute bottom-1 right-0 z-20 group/fire cursor-pointer h-10 w-10 flex flex-col items-center justify-end">
                                        <div class="relative w-8 h-8 flex items-center justify-center transition-transform duration-300 ease-out group-hover/fire:-translate-y-3 will-change-transform">
                                            <svg class="w-6 h-6 text-red-500 drop-shadow-md relative z-10" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <span class="absolute bottom-0 opacity-0 translate-y-1 transition-all duration-300 ease-out group-hover/fire:opacity-100 group-hover/fire:translate-y-0 text-[10px] font-black uppercase tracking-wider text-red-500 px-1.5 py-0.5">Хит</span>
                                    </div>
                                {% endif %}

                                <div class="absolute bottom-2.5 left-3 z-20">
                                    <div class="flex items-center gap-1.5 px-2.5 py-1 bg-black/55 backdrop-blur-md rounded-lg shadow-lg whitespace-nowrap">
                                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13 2L3 14h9v8l10-12h-9V2z"/>
                                        </svg>
                                        <span class="text-[11px] font-normal tracking-wide text-white">Продано {{ month_bestseller.total_sold }} шт.</span>
                                    </div>
                                </div>

                                {% if month_bestseller.annotated_discount_percentage > 0 %}
                                    <div class="absolute top-0 right-0 w-24 h-24 overflow-hidden z-20">
                                        <span class="absolute tracking-wide -top-7 -right-10 bg-blue-500 text-white text-xs font-geologica font-bold px-9 py-1 transform rotate-45 origin-bottom-left shadow-md">Скидка</span>
                                        <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-sm font-black text-white/20 select-none">{{ month_bestseller.annotated_discount_percentage|floatformat:0 }}%</span>
                                    </div>
                                {% endif %}

                                {% if month_bestseller.condition %}
                                    <span class="absolute top-2.5 left-2.5 z-20 inline-flex items-center justify-center w-8 h-[22px] font-montserrat font-medium rounded-md text-[9px] bg-white/90 backdrop-blur-sm text-black shadow-sm border border-gray-200/50 cursor-default" title="Состояние">{{ month_bestseller.condition|truncatechars:2|upper }}</span>
                                {% endif %}

                                {% if month_bestseller.has_autograph %}
                                    <span class="group absolute top-2 left-12 z-20 inline-flex items-center justify-center w-8 h-[22px] rounded-md bg-white backdrop-blur-sm text-black shadow-sm border border-purple-500 cursor-default" title="С автографом">
                                        <svg class="signature-icon w-3.5 h-3.5 mt-1 ml-0.5 text-purple-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 576" fill="currentColor">
                                            <path d="M623.2 128c-51.8 3.5-125.7 54.7-163.1 71.5-29.1 13.1-54.2 24.4-76.1 24.4-22.6 0-26-16.2-21.3-51.9 1.1-8 11.7-79.2-42.7-76.1-25.1 1.5-64.3 24.8-169.5 126L192 118.2c30.4-75.9-53.2-151.5-129.7-102.8L7.4 52.3C0 57-2.2 66.9 2.5 74.4l17.2 27c4.7 7.5 14.6 9.7 22.1 4.9l58-38.9c18.4-11.7 40.7 7.2 32.7 27.1L34.3 340.1C27.5 357 37 384 64 384c8.3 0 16.5-3.2 22.6-9.4 42.2-42.2 154.7-150.7 211.2-195.8-2.2 28.5-2.1 58.9 20.6 83.8 15.3 16.8 37.3 25.3 65.5 25.3 35.6 0 68-14.6 102.3-30 33-14.8 99-62.6 138.4-65.8 8.5-.7 15.2-7.3 15.2-15.8v-32.1c.2-9.1-7.5-16.8-16.6-16.2z"/>
                                        </svg>  
                                    </span>
                                {% endif %}
                            </div>

                            <!-- Контент карточки -->
                            <div class="p-4 relative">      
                                <div class="mb-1.5 tracking-wide">
                                    <h5 class="text-sm font-normal text-gray-600 hover:text-blue-600 transition-colors duration-300">
                                        <a href="{{ month_bestseller.artist.get_absolute_url }}">{{ month_bestseller.artist.name }}</a>
                                    </h5>
                                    <h5 class="text-base font-semibold text-black hover:text-blue-600 transition-colors duration-300 leading-tight">
                                        <a href="{{ month_bestseller.get_absolute_url }}">{{ month_bestseller.name }}</a>
                                    </h5>
                                </div>

                                <div class="flex items-center gap-1 mt-1 mb-3.5 overflow-hidden w-full h-[24px]">
                                    <div class="shrink-0 -ml-0.5 text-gray-400/60">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                                        </svg>
                                    </div>
                                    <div class="flex items-center gap-1 flex-1 min-w-0">
                                        {% for style in month_bestseller.visible_styles %}
                                            <span class="text-[10px] font-normal px-2.5 py-[3px] bg-white border border-gray-100 text-black rounded-lg shadow-soft whitespace-nowrap cursor-default transition-colors duration-200 hover:bg-gray-100/50 shrink-0">
                                                {{ style.name }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    {% if month_bestseller.stock %}
                                        <div class="flex items-center gap-1.5">
                                            <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                                            <span class="text-[11px] font-normal text-black">В наличии</span>
                                        </div>
                                    {% else %}
                                        <div class="flex items-center gap-1.5">
                                            <div class="w-1.5 h-1.5 rounded-full bg-red-400"></div>
                                            <span class="text-[11px] font-normal text-black">Нет в наличии</span>
                                        </div>
                                    {% endif %}
                                    <a class="text-[11px] text-blue-600 font-medium hover:underline" href="{{ month_bestseller.get_absolute_url }}">Подробнее</a>
                                </div>
                            </div>
                        </a>
                    </div>
                {% else %}
                    <div class="w-full bg-gray-50/50 rounded-xl border-2 border-dashed border-gray-300/60 flex flex-col overflow-hidden select-none hover:border-gray-400/60 transition-colors duration-300">
                        
                        <!-- Верхняя часть: Имитация обложки -->
                        <div class="w-full h-[230px] bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center relative overflow-hidden">
                            <!-- Фоновый паттерн (полоски) -->
                            <div class="absolute inset-0 opacity-[0.03]" style="background-image: repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%); background-size: 10px 10px;"></div>
                            
                            <!-- Иконка -->
                           <div class="relative z-10 w-20 h-20 rounded-full bg-white/50 backdrop-blur-sm flex items-center justify-center shadow-sm">
                              <svg class="w-10 h-10 text-gray-400" viewBox="0 0 512 512" fill="currentColor">
                                  <path d="M256 160C202.9 160 160 202.9 160 256s42.92 96 96 96c53.08 0 96-42.92 96-96S309.1 160 256 160zM256 288C238.3 288 224 273.7 224 256s14.33-32 32-32c17.67 0 32 14.33 32 32S273.7 288 256 288zM256 0c-141.4 0-256 114.6-256 256s114.6 256 256 256c141.4 0 256-114.6 256-256S397.4 0 256 0zM256 384c-70.75 0-128-57.25-128-128s57.25-128 128-128s128 57.25 128 128S326.8 384 256 384z"/>
                              </svg>
                          </div>
                        </div>

                        <!-- Нижняя часть: Имитация текста -->
                        <div class="p-4 flex flex-col gap-3">
                            <!-- Имитация заголовка -->
                            <div class="space-y-2">
                                <div class="h-3 bg-gray-200 rounded-full w-2/3 animate-pulse"></div>
                                <div class="h-4 bg-gray-200 rounded-full w-full animate-pulse"></div>
                            </div>
                            
                            <!-- Имитация тегов -->
                            <div class="flex gap-2 mt-1">
                                <div class="h-5 bg-gray-100 rounded-md w-12"></div>
                                <div class="h-5 bg-gray-100 rounded-md w-16"></div>
                            </div>

                            <!-- Имитация футера карточки -->
                            <div class="flex justify-between items-center border-t border-gray-100">
                                <span class="text-[10px] text-gray-400 font-medium">Хит месяца отсутствует</span>
                                <div class="h-3 bg-gray-200 rounded w-14"></div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</section>

<style>
  .slider-highlights .swiper-button-prev,
  .slider-highlights .swiper-button-next { display: none !important; }

  .custom-prev, .custom-next {
    position: absolute; top: 50%; transform: translateY(-50%);
    z-index: 20; cursor: pointer; transition: all 0.3s ease;
    opacity: 0; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .slider-highlights:hover .custom-prev,
  .slider-highlights:hover .custom-next { opacity: 1; }
  .custom-prev:hover, .custom-next:hover { transform: translateY(-50%) scale(1.1); }
  .custom-prev { left: 20px; }
  .custom-next { right: 20px; }

  .custom-pagination {
    position: absolute; top: 24px !important; right: 24px !important;
    bottom: auto !important; left: auto !important; width: auto !important;
    display: flex; justify-content: flex-end; align-items: center; z-index: 20;
    gap: 8px; background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px); padding: 8px 14px;
    border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .custom-pagination .swiper-pagination-bullet {
    width: 8px; height: 8px; background: rgba(255, 255, 255, 0.5);
    border-radius: 50%; opacity: 1; margin: 0 !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
  }
  .custom-pagination .swiper-pagination-bullet:hover { background: rgba(255, 255, 255, 0.9); }
  .custom-pagination .swiper-pagination-bullet-active {
    width: 32px; height: 8px; background: #ffffff;
    border-radius: 4px; box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
  }
</style>

<script src="https://unpkg.com/swiper@11/swiper-bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const slideCount = document.querySelectorAll('.slider-highlights .swiper-slide').length;
    
    if (slideCount > 1) {
      const prev = document.querySelector('.custom-prev');
      const next = document.querySelector('.custom-next');
      if(prev) prev.style.display = 'block';
      if(next) next.style.display = 'block';
    } else {
      const prev = document.querySelector('.custom-prev');
      const next = document.querySelector('.custom-next');
      if(prev) prev.style.display = 'none';
      if(next) next.style.display = 'none';
      
      const pag = document.querySelector('.custom-pagination');
      if(pag) pag.style.display = 'none';
    }
    
    const swiper = new Swiper('.slider-highlights', {
      loop: slideCount > 1, 
      autoplay: slideCount > 1 ? { delay: 6000, disableOnInteraction: false } : false, 
      pagination: { el: '.custom-pagination', clickable: true },
      navigation: { nextEl: '.custom-next', prevEl: '.custom-prev' },
      speed: 700, effect: 'slide',
      allowTouchMove: slideCount > 1,
    });
  });
</script>