{% extends 'unfold/layouts/base.html' %}
{% load i18n static unfold humanize %}

{% block breadcrumbs %}{% endblock %}

{% block title %}
    {% if subtitle %}
        {{ subtitle }} |
    {% endif %}
    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å | {{ site_title|default:_('Django site admin') }}
{% endblock %}

{% block branding %}
    {% include "unfold/helpers/site_branding.html" %}
{% endblock %}

{% block extrahead %}
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        montserrat: ['Montserrat', 'sans-serif'],
                    }
                }
            },
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    
    <style>
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
    </style>
{% endblock %}

{% block content %}
{% component "unfold/components/container.html" %}
<div class="dashboard-page relative max-w-8xl mx-auto py-2 tracking-wide font-montserrat">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div class="mb-6 p-6 bg-white border border-gray-100 rounded-2xl shadow-sm flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2.5">
                <span class="text-2xl">üìä</span>
                –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            </h1>
            <p class="text-gray-500 text-sm mt-1 font-normal">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</p>
        </div>
        
        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="hidden md:flex flex-col items-end">
            <span class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-0.5">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
            <div class="flex items-center gap-2 text-lg font-bold text-gray-800">
                –î–æ–±—Ä—ã–π –¥–µ–Ω—å, 
                <span class="text-blue-600">{{ request.user.first_name|default:request.user.username }}</span>
                <span class="text-2xl animate-wave origin-bottom-right inline-block hover:rotate-12 transition-transform">üëã</span>
            </div>
        </div>
    </div>

    <!-- –í–µ—Ä—Ö–Ω—è—è —Å–µ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6 flex flex-col justify-between">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900 tracking-wider flex items-center gap-2">
                    <span class="text-2xl">üìà</span> –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </h2>
                <span class="text-2xl font-bold text-gray-900" id="totalRegistrations">0</span>
            </div>
            <div class="relative h-48 w-full">
                <canvas id="registrationsChart"></canvas>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6 flex flex-col justify-between">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900 tracking-wider flex items-center gap-2">
                    <span class="text-2xl">üõí</span> –ó–∞–∫–∞–∑—ã
                </h2>
                <span class="text-2xl font-bold text-gray-900" id="totalOrders">0</span>
            </div>
            <div class="relative h-48 w-full">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
    </div>

    <!-- –ù–ò–ñ–ù–Ø–Ø –°–ï–ö–¶–ò–Ø -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
        
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –í—ã—Ä—É—á–∫–∞ -->
        <div class="xl:col-span-1">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-0 overflow-hidden flex flex-col h-full">
                <div class="p-6 pb-2">
                    <div class="flex items-center gap-1 mb-2">
                        <span class="text-2xl">üí∞</span>
                        <h2 class="text-xl font-bold text-gray-900 tracking-wider flex items-center gap-2">
                            –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç
                        </h2>
                    </div>
                    
                    <div class="mt-4 flex items-baseline gap-2">
                        <span class="text-4xl font-montserrat font-bold text-gray-900">
                            {{ total_period_revenue|floatformat:0|intcomma }} ‚ÇΩ
                        </span>
                    </div>
                    <p class="text-gray-400 text-sm font-normal mt-1">–°—É–º–º–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏</p>
                </div>

                <div class="relative w-full flex-grow min-h-[180px] px-8 pb-2">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –¢–∞–±–ª–∏—Ü–∞ –∞–ª—å–±–æ–º–æ–≤ -->
        <div class="xl:col-span-2 bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden flex flex-col">
            <!-- –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -->
            <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100 bg-white">
                <h2 class="text-xl font-bold text-gray-900 tracking-wider flex items-center gap-2">
                    <span class="text-xl">üíø</span> –ù–æ–≤–∏–Ω–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞
                </h2>
                
                <div class="flex items-center gap-2.5">
                    <a href="{% url 'admin:catalog_album_changelist' %}" title="–í–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥"
                       class="h-9 w-9 flex items-center justify-center bg-white text-gray-400/60 hover:text-blue-600 border border-gray-200 hover:border-gray-300 hover:bg-gray-50 rounded-lg transition-all shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-[18px] w-[18px]" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                        </svg>
                    </a>
                    
                    <a href="{% url 'admin:catalog_album_add' %}" 
                       class="h-9 px-4 flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold uppercase tracking-wide rounded-lg transition-all shadow-sm hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        –î–æ–±–∞–≤–∏—Ç—å
                    </a>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50/50 border-b border-gray-100 text-[11px] uppercase tracking-wider text-gray-500 font-bold">
                            <th class="pl-7 py-4 w-[6%] whitespace-nowrap text-left">ID</th>
                            <th class="px-4 py-4 w-[50%]">–ê–ª—å–±–æ–º</th>
                            <th class="px-4 py-4 w-[0%] pl-10 text-left whitespace-nowrap">–¶–µ–Ω–∞</th>
                            <th class="px-4 py-4 w-[18%] text-center whitespace-nowrap">–ü—Ä–æ–¥–∞–Ω–æ (—à—Ç.)</th>
                            <th class="px-4 py-4 w-[24%] text-left whitespace-nowrap">–ù–∞–ª–∏—á–∏–µ</th>
                            <th class="pr-6 py-4 w-[5%] text-right"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 text-sm">
                        {% for album in latest_albums %}
                            <tr class="group hover:bg-gray-50 transition-colors duration-200">
                                
                                <!-- ID -->
                                <td class="pl-6 py-4 align-middle whitespace-nowrap">
                                    <span class="text-xs font-medium text-gray-900 -ml-1 bg-gray-50 px-2 py-1 rounded-md border border-gray-200">
                                        {{ album.id }}
                                    </span>
                                </td>

                                <!-- –ê–ª—å–±–æ–º -->
                                <td class="px-4 py-4 align-middle">
                                    <div class="flex items-center gap-3">
                                        <div class="relative h-10 w-10 flex-shrink-0">
                                            {% if album.image %}
                                                <img class="h-10 w-10 rounded-lg object-cover shadow-sm border border-gray-200" src="{{ album.image.url }}" alt="">
                                            {% else %}
                                                <div class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 border border-gray-200">üíø</div>
                                            {% endif %}
                                        </div>
                                        <div class="flex flex-col overflow-hidden max-w-[250px]">
                                            <span class="font-medium text-gray-900 truncate group-hover:text-blue-600 transition-colors" title="{{ album.name }}">
                                                {{ album.name }}
                                            </span>
                                            <span class="text-[13px] text-gray-500 font-normal truncate" title="{{ album.artist.name }}">{{ album.artist.name }}</span>
                                        </div>
                                    </div>
                                </td>

                                <!-- –¶–µ–Ω–∞  -->
                                <td class="px-4 py-4 pl-10 align-middle text-left whitespace-nowrap tabular-nums">
                                    <div class="flex items-center justify-start gap-2">
                                        <div class="flex flex-col items-start">
                                            {% if album.annotated_discounted_price %}
                                                <span class="font-semibold text-gray-900">{{ album.annotated_discounted_price|floatformat:0|intcomma }} ‚ÇΩ</span>
                                            {% else %}
                                                <span class="text-[10px] text-gray-400 italic">–ù–µ –∑–∞–¥–∞–Ω–∞</span>
                                            {% endif %}
                                        </div>

                                        {% if album.pricelist_item_id %}
                                            <a href="{% url 'admin:catalog_pricelistitem_change' album.pricelist_item_id %}" 
                                               title="–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É"
                                               class="text-gray-400 hover:text-blue-600 hover:bg-blue-50 p-1.5 rounded-md transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </a>
                                        {% elif active_pricelist_id %}
                                            <a href="{% url 'admin:catalog_pricelistitem_add' %}?price_list={{ active_pricelist_id }}&album={{ album.id }}" 
                                               title="–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É"
                                               class="text-green-500 hover:text-green-700 hover:bg-green-50 p-1.5 rounded-md transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- –ü—Ä–æ–¥–∞–Ω–æ -->
                                <td class="px-4 py-4 align-middle text-center whitespace-nowrap">
                                    <span class="text-xs font-medium text-gray-900 bg-gray-50 px-2 py-1 rounded-md border border-gray-200">
                                        {{ album.total_sold }}
                                    </span>
                                </td>

                                <!-- –ù–∞–ª–∏—á–∏–µ -->
                                <td class="px-4 py-4 align-middle text-left whitespace-nowrap">
                                    <div class="flex items-center justify-start gap-2">
                                        {% if album.out_of_stock or album.stock == 0 %}
                                            <span class="relative flex h-1.5 w-1.5">
                                              <span class="animate-pulse absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                              <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-red-500"></span>
                                            </span>
                                            <span class="text-xs font-medium text-gray-500">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                        {% else %}
                                            <span class="relative flex h-1.5 w-1.5">
                                              <span class="animate-pulse absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                              <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                                            </span>
                                            <span class="text-xs font-medium text-gray-500">–í –Ω–∞–ª–∏—á–∏–∏</span>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
                                <td class="pr-6 py-4 align-middle text-right whitespace-nowrap">
                                    <a href="{% url 'admin:catalog_album_change' album.id %}" 
                                       class="inline-block text-gray-400 hover:text-gray-900 transition-colors"
                                       title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–ª—å–±–æ–º—É">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="6" class="py-8 text-center text-gray-400 text-xs">–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
             <!-- –§—É—Ç–µ—Ä —Ç–∞–±–ª–∏—Ü—ã -->
            <div class="bg-gray-50/80 px-5 py-2 border-t border-gray-200 flex justify-center">
                <a href="{% url 'admin:catalog_album_changelist' %}" class="text-[11px] font-bold text-gray-400 hover:text-blue-600 transition-colors uppercase tracking-widest flex items-center gap-1">
                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                </a>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
<script>
    Chart.defaults.font.family = "'Montserrat', sans-serif";
    Chart.defaults.font.weight = '500';

    function getChartOptions(unitName, smooth) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: { left: 0, right: 0, top: 20, bottom: 0 }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(17, 24, 39, 0.9)', 
                    titleColor: '#fff', 
                    bodyColor: '#fff',
                    borderColor: '#374151',
                    borderWidth: 1,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        title: function(tooltipItems) { return tooltipItems[0].label; },
                        label: function(context) { 
                            return context.parsed.y.toLocaleString('ru-RU') + ' ' + unitName; 
                        }
                    }
                }
            },
            scales: {
                x: { 
                    display: true, 
                    grid: { display: false },
                    ticks: {
                        color: '#9ca3af',
                        font: { size: 10 },
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 6
                    },
                    border: { display: false }
                }, 
                y: { 
                    display: true, 
                    beginAtZero: true,
                    ticks: {
                        display: true,
                        color: '#d1d5db',
                        font: { size: 10 },
                        maxTicksLimit: 5,
                        padding: 10,
                        precision: 0 
                    },
                    grid: { 
                        display: true,
                        color: '#f3f4f6', 
                        borderDash: [5, 5],
                        drawBorder: false
                    },
                    border: { display: false }
                }
            },
            elements: {
                point: {
                    radius: 2.5, 
                    hitRadius: 20,    
                    hoverRadius: 5,
                    borderWidth: 2, 
                    borderColor: '#fff' 
                },
                line: {
                    borderWidth: 3,
                    tension: smooth ? 0.4 : 0 
                }
            }
        };
    }

    // 1. –ì—Ä–∞—Ñ–∏–∫ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
    const ctxReg = document.getElementById('registrationsChart').getContext('2d');
    const regData = {{ registration_data|safe }};
    document.getElementById('totalRegistrations').textContent = regData.counts.reduce((a, b) => a + b, 0);

    new Chart(ctxReg, {
        type: 'line',
        data: {
            labels: regData.labels,
            datasets: [{
                label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                data: regData.counts,
                borderColor: '#2563eb', 
                backgroundColor: 'rgba(37, 99, 235, 0.05)',
                pointBackgroundColor: '#2563eb',
                fill: true,
            }]
        },
        options: getChartOptions('—á–µ–ª.', true)
    });

    // 2. –ì—Ä–∞—Ñ–∏–∫ –ó–∞–∫–∞–∑–æ–≤
    const ctxOrd = document.getElementById('ordersChart').getContext('2d');
    const ordData = {{ order_data|safe }};
    document.getElementById('totalOrders').textContent = ordData.counts.reduce((a, b) => a + b, 0);

    new Chart(ctxOrd, {
        type: 'line',
        data: {
            labels: ordData.labels,
            datasets: [{
                label: '–ó–∞–∫–∞–∑—ã',
                data: ordData.counts,
                borderColor: '#16a34a',
                backgroundColor: 'rgba(22, 163, 74, 0.05)',
                pointBackgroundColor: '#16a34a',
                fill: true,
            }]
        },
        options: getChartOptions('–∑–∞–∫.', true)
    });

    // 3. –ì—Ä–∞—Ñ–∏–∫ –í—ã—Ä—É—á–∫–∏
    const ctxRev = document.getElementById('revenueChart').getContext('2d');
    const revData = {{ revenue_data|safe }};

    new Chart(ctxRev, {
        type: 'bar',
        data: {
            labels: revData.labels,
            datasets: [{
                data: revData.counts,
                backgroundColor: '#3b82f6', 
                borderRadius: 3,
                barThickness: 'flex',
                maxBarThickness: 35, 
                categoryPercentage: 0.85,
                barPercentage: 0.9,
                hoverBackgroundColor: '#2563eb'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 0 },
            plugins: {
                legend: { display: false },
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–≤–µ–ª–∏—á–µ–Ω padding –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ
                tooltip: {
                    backgroundColor: 'rgba(17, 24, 39, 0.9)', 
                    titleColor: '#fff', 
                    bodyColor: '#fff',
                    padding: 12, // –ë—ã–ª–æ 5, —Å—Ç–∞–ª–æ 12
                    cornerRadius: 4,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toLocaleString('ru-RU') + ' ‚ÇΩ';
                        }
                    }
                }
            },
            scales: {
                x: { 
                    display: true, 
                    grid: { display: false, drawBorder: false },
                    ticks: { 
                        font: { size: 9 },
                        color: '#9ca3af',
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 5
                    },
                    border: { display: false }
                },
                y: { display: false }
            }
        }
    });
</script>
{% endcomponent %}
{% endblock %}