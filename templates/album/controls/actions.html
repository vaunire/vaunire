{% load humanize %}

{% if user.is_authenticated %}
<!-- Основной контейнер с уникальным ID -->
<div class="flex gap-4 mt-4 h-11 w-full" id="detail-actions-{{ album.id }}">
    
    <!-- 1. Проверка наличия -->
    {% if album.stock %}
        
        <!-- 1.1 Товар есть в корзине -->
        {% if cart_item %}
            
            <div class="flex flex-1 gap-3">
                
                <!-- Кнопка перехода в корзину -->
                <a href="{% url 'cart' %}" 
                   class="flex-1 bg-green-600 text-white rounded-lg font-bold text-sm tracking-wide flex items-center justify-center hover:bg-green-700 transition-colors shadow-sm group px-4">
                    <span class="mr-1.5">В корзине</span>
                    <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                </a>

                <!-- Управление количеством (+ / -) -->
                <form hx-post="{% url 'change_quantity' ct_model=album.ct_model slug=album.slug %}" 
                      hx-target="#detail-actions-{{ album.id }}" 
                      hx-swap="outerHTML"
                      hx-headers='{"X-Source": "detail"}'
                      class="flex items-center bg-white border border-gray-200 rounded-lg p-1 h-full">
                    
                    {% csrf_token %}
                    
                    <button type="submit" name="action" value="decrease" 
                            class="w-8 h-full flex items-center justify-center text-gray-500 hover:text-red-500 hover:bg-gray-50 rounded transition-colors">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                        </svg>
                    </button>
                    
                    <div class="w-8 text-center font-semibold text-gray-700 text-sm">
                        {{ cart_item.quantity }}
                    </div>
                    
                    <button type="submit" name="action" value="increase" 
                            class="w-8 h-full flex items-center justify-center rounded transition-colors 
                            {% if cart_item.quantity >= album.stock %}
                                text-gray-300 cursor-not-allowed
                            {% else %}
                                text-gray-500 hover:text-green-600 hover:bg-gray-50
                            {% endif %}"
                            {% if cart_item.quantity >= album.stock %}disabled{% endif %}>
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </form>
            </div>

        <!-- 1.2 Товара нет в корзине -->
        {% else %}
            
            <button hx-get="{% url 'add_to_cart' ct_model=album.ct_model slug=album.slug %}" 
                    hx-target="#detail-actions-{{ album.id }}" 
                    hx-swap="outerHTML"
                    hx-headers='{"X-Source": "detail"}'
                    class="flex-1 bg-blue-600 text-white rounded-lg font-bold text-sm tracking-wider flex items-center justify-center hover:bg-blue-700 transition-colors shadow-sm">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                    <path fill-rule="evenodd" d="M10 2.25a1.75 1.75 0 0 0-1.582 1c-.684.006-1.216.037-1.692.223A3.25 3.25 0 0 0 5.3 4.563c-.367.493-.54 1.127-.776 1.998l-.047.17-.513 2.964c-.185.128-.346.28-.486.459c-.901 1.153-.472 2.87.386 6.301c.545 2.183.818 3.274 1.632 3.91C6.31 21 7.435 21 9.685 21h4.63c2.25 0 3.375 0 4.189-.635c.814-.636 1.086-1.727 1.632-3.91c.858-3.432 1.287-5.147.386-6.301a2.186 2.186 0 0 0-.487-.46l-.513-2.962l-.046-.17c-.237-.872-.41-1.506-.776-2a3.25 3.25 0 0 0-1.426-1.089c-.476-.186-1.009-.217-1.692-.222A1.75 1.75 0 0 0 14 2.25zm8.418 6.896l-.362-2.088c-.283-1.04-.386-1.367-.56-1.601a1.75 1.75 0 0 0-.768-.587c-.22-.086-.486-.111-1.148-.118A1.75 1.75 0 0 1 14 5.75h-4a1.75 1.75 0 0 1-1.58-.998c-.663.007-.928.032-1.148.118a1.75 1.75 0 0 0-.768.587c-.174.234-.277.56-.560 1.6l-.362 2.089C6.58 9 7.91 9 9.685 9h4.63c1.775 0 3.105 0 4.103.146M8 12.25a.75.75 0 0 1 .75.75v4a.75.75 0 0 1-1.5 0v-4a.75.75 0 0 1 .75-.75m8.75.75a.75.75 0 0 0-1.5 0v4a.75.75 0 0 0 1.5 0zM12 12.25a.75.75 0 0 1 .75.75v4a.75.75 0 0 1-1.5 0v-4a.75.75 0 0 1 .75-.75" clip-rule="evenodd"/>
                </svg>
                В корзину
            </button>

        {% endif %}

    <!-- 2. Нет в наличии (Лист ожидания) -->
    {% else %}
        <div class="w-full">
            {% if is_in_wishlist %}
                <button hx-get="{% url 'remove_from_wishlist' album_id=album.id %}" 
                        hx-target="#detail-actions-{{ album.id }}" 
                        hx-swap="outerHTML" 
                        hx-headers='{"X-Source": "detail"}' 
                        class="w-full bg-white text-amber-400 border border-amber-200 rounded-lg font-bold text-sm px-8 py-3 hover:bg-amber-50/85 hover:border-amber-300 transition-all flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd"/>
                    </svg>
                    В листе ожидания
                </button>
            {% else %}
                <button hx-get="{% url 'add_to_wishlist' album_id=album.id %}" 
                        hx-target="#detail-actions-{{ album.id }}" 
                        hx-swap="outerHTML" 
                        hx-headers='{"X-Source": "detail"}' 
                        class="w-full bg-gray-700 text-white rounded-lg font-bold text-sm px-8 py-3 hover:bg-gray-600 transition-all">
                    Сообщить о поступлении
                </button>
            {% endif %}
        </div>
    {% endif %}
    
    <!-- 3. Избранное -->
    {% if is_in_favorite %}
        <button hx-get="{% url 'remove_from_favorite' album_id=album.id %}" 
                hx-target="#detail-actions-{{ album.id }}" 
                hx-swap="outerHTML"
                hx-headers='{"X-Source": "detail"}'
                class="w-[52px] flex items-center justify-center border border-gray-200 rounded-lg text-red-500 bg-white hover:bg-gray-50 transition-colors"
                title="Удалить из избранного">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        </button>
    {% else %}
        <button hx-get="{% url 'add_to_favorite' album_id=album.id %}" 
                hx-target="#detail-actions-{{ album.id }}" 
                hx-swap="outerHTML"
                hx-headers='{"X-Source": "detail"}'
                class="w-[52px] flex items-center justify-center border border-gray-200 rounded-lg text-gray-400 hover:text-gray-500 hover:border-gray-300 hover:bg-gray-50 transition-colors"
                title="Добавить в избранное">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                </svg>
        </button>
    {% endif %}
</div>
 {% endif %}