<style>
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
</style>

{% if recently_viewed_albums %}
<div x-data="smoothCarousel({% if recently_viewed_albums|length > 10 %}3{% else %}2{% endif %})" 
     class="max-w-[1345px] mx-auto mb-20 px-4 lg:px-8 font-montserrat">
    
    <div class="flex items-center justify-between mb-3.5">
        <h2 class="text-xl font-semibold">Ваши находки</h2>
        
        {% if recently_viewed_albums|length > 5 %}
        <div class="flex items-center">
            <!-- Точки -->
            <div class="flex items-center gap-1.5 mr-4">
                <div class="w-1.5 h-1.5 rounded-full transition-colors duration-200" 
                     :class="activeDot === 0 ? 'bg-black' : 'bg-gray-300'"></div>
                
                <div class="w-1.5 h-1.5 rounded-full transition-colors duration-200" 
                     :class="activeDot === 1 ? 'bg-black' : 'bg-gray-300'"></div>

                {% if recently_viewed_albums|length > 10 %}
                <div class="w-1.5 h-1.5 rounded-full transition-colors duration-200" 
                     :class="activeDot === 2 ? 'bg-black' : 'bg-gray-300'"></div>
                {% endif %}
            </div>

            <div class="flex items-center gap-1.5">
                <button @click="scroll('left')" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors active:scale-95">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <button @click="scroll('right')" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors active:scale-95">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="relative group">
        <div x-ref="container" 
             @scroll.passive="updateDots"
             class="flex gap-5 overflow-x-auto hide-scrollbar pb-4 touch-pan-x"
             style="will-change: scroll-position; scroll-behavior: auto !important;">
            
            {% for album in recently_viewed_albums %}
                <div class="flex-shrink-0 w-[240px]">
                    {% include 'catalog/cards/grid_card.html' with album=album %}
                </div>
            {% endfor %}
            
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('smoothCarousel', (totalDots) => ({
        activeDot: 0,
        rafId: null,
        totalDots: totalDots,

        scroll(direction) {
            const container = this.$refs.container;
            const amount = 520;
            const duration = 1300;
            
            const start = container.scrollLeft;
            const change = direction === 'left' ? -amount : amount;
            const startTime = performance.now();

            if (this.rafId) cancelAnimationFrame(this.rafId);

            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                let progress = elapsed / duration;
                if (progress > 1) progress = 1;

                const ease = 1 - Math.pow(1 - progress, 3);
                
                container.scrollLeft = start + (change * ease);

                if (elapsed < duration) {
                    this.rafId = requestAnimationFrame(animate);
                } else {
                    this.rafId = null;
                    container.scrollLeft = start + change;
                }
            };

            this.rafId = requestAnimationFrame(animate);
        },

        updateDots() {
            const el = this.$refs.container;
            const maxScroll = el.scrollWidth - el.clientWidth;
            if (maxScroll <= 0) return;

            let progress = el.scrollLeft / maxScroll;
            
            if (progress < 0) progress = 0;
            if (progress > 1) progress = 1;

            this.activeDot = Math.round(progress * (this.totalDots - 1));
        }
    }));
});
</script>
{% endif %}