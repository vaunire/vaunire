{% load humanize %}

<div x-data="{ 
        isOpen: false,
        init() {
            // Блокируем скролл фона при открытии
            this.$watch('isOpen', value => {
                document.body.style.overflow = value ? 'hidden' : '';
            });
        }
     }"
     @open-modal-details-{{ order.id }}.window="isOpen = true"
     @keydown.escape.window="isOpen = false">

    <template x-teleport="body">
        <div class="fixed inset-0 bg-gray-800 bg-opacity-60 z-[9999] flex items-center justify-center backdrop-blur-[2px]"
             x-show="isOpen"
             style="display: none;">
            
            <!-- Панель окна -->
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-[820px] max-h-[85vh] flex flex-col relative"
                 @click.outside="isOpen = false">
                
                <!-- 1. Шапка -->
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <svg class="text-blue-600 w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/>
                        </svg>
                        <h3 class="text-lg font-medium text-black">Детали заказа №{{ order.id }}</h3>
                    </div>
                    
                    <!-- Статус бар и иконки статуса (из твоего кода) -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <!-- Прогресс бар -->
                            <div class="w-32 h-1 bg-blue-100 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 rounded-full transition-all duration-300"
                                     style="width: {% if order.status == 'completed' %}100%{% elif order.status == 'in_progress' %}66%{% elif order.status == 'confirmed' %}33%{% else %}10%{% endif %}">
                                </div>
                            </div>
                            
                            <!-- Иконка статуса -->
                            {% if order.status == 'new' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-md bg-blue-100 text-blue-700">New</span>
                            {% elif order.status == 'in_progress' %}
                                <svg class="w-4 h-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            {% elif order.status == 'completed' %}
                                <svg class="w-3.5 h-3.5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                                </svg>
                            {% elif order.status == 'canceled' %}
                                <svg class="w-3.5 h-3.5 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            {% endif %}
                        </div>
                        
                        <!-- Кнопка закрытия -->
                        <button @click="isOpen = false" class="text-gray-400 hover:text-gray-600 focus:outline-none p-1 rounded-md hover:bg-gray-100 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 2. Контент (скролл) -->
                <div class="overflow-y-auto p-6 custom-scrollbar flex-1">
                    
                    <!-- Список товаров -->
                    <div class="space-y-3 mb-6">
                        {% for item in order.cart.products.all %}
                            <div class="flex items-center gap-4 group">
                                <img src="{{ item.content_object.image.url }}" alt="{{ item.content_object.name }}" class="w-16 h-16 object-cover rounded-md shadow-sm border border-gray-100">
                                
                                <div class="flex-1 min-w-0">
                                    <a href="{{ item.content_object.get_absolute_url }}" class="text-sm font-normal text-black hover:text-blue-600 transition-colors duration-200 block truncate">
                                        {{ item.content_object.name }} – {{ item.content_object.artist.name }}
                                    </a>
                                    <p class="text-[13px] text-gray-500 font-normal -mb-0.5">
                                        {% if item.content_object.styles.all %}
                                            {% for style in item.content_object.styles.all %}
                                                {{ style.name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </p>
                                </div>
                                
                                <div class="text-sm font-medium text-black flex items-center whitespace-nowrap">
                                    <span class="font-normal text-xs text-gray-500/80 mr-1.5">{{ item.quantity }} шт. ×</span>
                                    <span>{{ item.unit_price|floatformat:0|intcomma }} ₽</span>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-sm text-gray-500 italic text-center">Товары в заказе отсутствуют</p>
                        {% endfor %}
                    </div>

                    <!-- Информационная карточка -->
                    <div class="border border-gray-100 rounded-2xl p-4 cursor-default bg-white shadow-sm">
                        <div class="flex flex-col gap-3">
                            
                            <!-- Ряд 1: Чипы -->
                            <div class="flex flex-wrap gap-2 text-[13px]">
                                <!-- Дата -->
                                <div class="group inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-50 text-gray-900 border border-gray-100 hover:shadow transition-all duration-200">
                                    <svg class="w-[17px] h-[17px] text-gray-400/65 mb-0.5 group-hover:text-blue-600 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <rect x="4" y="6" width="16" height="15" rx="2"/><path d="M4 10h16"/><path d="M8 3v3m8-3v3"/>
                                    </svg>
                                    <span class="font-normal">{{ order.order_date|date:"d.m.Y" }}</span>
                                </div>

                                <!-- Время -->
                                <div class="group inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-50 text-gray-900 border border-gray-100 hover:shadow transition-all duration-200">
                                    <svg class="w-[15px] h-[15px] mb-[1px] text-gray-400/70 group-hover:text-blue-600 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2.6" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3" stroke-linecap="round"/>
                                    </svg>
                                    <span class="font-normal">11:00 - 20:00</span>
                                </div>

                                <!-- Тип доставки -->
                                <div class="group inline-flex items-center gap-2.5 px-3 py-1.5 rounded-lg bg-gray-50 text-gray-900 border border-gray-100 hover:shadow transition-all duration-200">
                                    <svg class="w-3.5 h-3.5 text-gray-400/75 group-hover:text-blue-600 transition-colors duration-200" viewBox="0 0 295.666 295.666" fill="currentColor">
                                        <path d="M280.666,8.619H77.373c-8.284,0-15,6.716-15,15v130.549l30-7.25v-108.3h173.293v130.402h-86.799 c11.96,6.343,20.018,17.501,22.805,30h78.994c8.284,0,15-6.716,15-15V23.619C295.666,15.335,288.95,8.619,280.666,8.619z"/>
                                        <path d="M239.224,230.988l-78.964,24.086c-5.955-4.051-51.679-35.162-59-40.143c5.335-2.495,9.928-4.642,16.025-7.493 l34.475,15.059c7.593,3.317,16.434-0.153,19.75-7.742c3.322-7.605-0.169-16.442-7.742-19.75l-46.191-20.177 c-2.936-1.282-6.279-1.619-9.527-0.834c-7.031,1.699-54.178,13.092-60.335,14.58H15c-8.009,0-14.533,6.282-14.959,14.185L0,236.062 v0c0,8.284,6.716,15,15,15h30.232c13.247,5.061,74.616,28.508,83.125,31.759c15.978,5.433,25.478,4.933,35.5,2.376 c2.9-0.74,22.664-6.76,84.118-25.514c7.924-2.417,12.389-10.8,9.972-18.724S247.146,228.574,239.224,230.988z"/>
                                    </svg>
                                    <span class="font-normal mb-[1px]">{{ order.get_buying_type_display }}</span>
                                </div>
                            </div>

                            <!-- Ряд 2: Адрес -->
                            <div class="flex items-start group hover:shadow transition-all gap-2.5 p-3 rounded-lg border border-dashed border-gray-200 bg-gray-50/50">
                                <svg class="w-4 h-4 text-gray-400/70 group-hover:text-blue-600 transition-colors duration-200 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <div class="flex-1 min-w-0 flex flex-col gap-0.5">
                                    <p class="text-[13px] text-gray-800 font-normal leading-snug break-words">
                                        {{ order.address }}
                                    </p>
                                    <a href="https://yandex.ru/maps/?text={{ order.address|urlencode }}" target="_blank" class="inline-flex items-center text-xs font-normal text-blue-700 hover:text-blue-800 transition-colors">
                                        Показать на карте
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="my-3 border-t border-gray-100"></div>

                    <!-- Нижняя часть: Статус и Цена -->
                    <div class="flex items-center justify-between">
                            
                    <!-- Статус -->
                    <div class="flex items-center gap-2">
                        <span class="text-[13px] text-gray-600 font-normal">Статус:</span>
                            {% include 'profile/components/status_badge.html' with status=order.status text=order.get_status_display %}
                    </div>

                    <!-- Цена -->
                    <div class="text-right">
                        <p class="text-blue-600 text-xl font-bold">
                            {{ order.cart.final_price|floatformat:0|default:'0'|intcomma }} ₽
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>