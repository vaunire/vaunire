{% load humanize %}

<div x-data="{ 
        isOpen: false,
        init() {
            // Блокируем прокрутку страницы при открытии окна
            this.$watch('isOpen', value => {
                document.body.style.overflow = value ? 'hidden' : '';
            });
        }
     }"
     @open-modal-return-details-{{ return_request.id }}.window="isOpen = true"
     @keydown.escape.window="isOpen = false">

     <template x-teleport="body">
        
        <!-- Затемненный фон -->
        <div class="fixed inset-0 bg-gray-800 bg-opacity-60 z-[9999] flex items-center justify-center backdrop-blur-[2px]"
             x-show="isOpen"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             style="display: none;">
            
            <!-- Панель модального окна -->
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[85vh] flex flex-col relative"
                 @click.outside="isOpen = false"
                 x-show="isOpen"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 translate-y-0"
                 x-transition:leave-end="opacity-0 translate-y-2">
                
                <!-- 1. Шапка -->
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <svg class="text-blue-600 w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1200">
                            <path fill="currentColor" d="M300 225L0 525h225v375h450L525 750H375V525h225zm225 75l150 150h150v225H600l300 300l300-300H975V300z"/>
                        </svg>
                        <h3 class="text-lg font-semibold text-black">
                            Детали возврата для заказа №{{ return_request.order.id }}
                        </h3>
                    </div>
                    
                    <!-- Кнопка закрытия -->
                    <button @click="isOpen = false" class="text-gray-400 hover:text-gray-600 focus:outline-none transition-colors p-1 rounded-md hover:bg-gray-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- 2. Скроллируемый контент -->
                <div class="overflow-y-auto p-6 custom-scrollbar flex-1">
                    
                    <!-- Список товаров -->
                    <div class="space-y-3">
                        {% for item in return_request.products.all %}
                            <div class="flex items-center gap-4">
                                <img src="{{ item.content_object.image.url }}" alt="{{ item.content_object.name }}" class="w-16 h-16 object-cover rounded-md shadow-sm border border-gray-100">
                                
                                <div class="flex-1 min-w-0">
                                    <a href="{{ item.content_object.get_absolute_url }}" class="text-sm font-normal text-black hover:text-blue-600 transition-colors duration-200 block truncate">
                                        {{ item.content_object.name }} – {{ item.content_object.artist.name }}
                                    </a>
                                    <p class="text-[13px] text-gray-500 font-normal -mb-0.5">
                                        {% if item.content_object.styles.all %}
                                            {% for style in item.content_object.styles.all %}
                                                {{ style.name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </p>
                                </div>
                                
                                <div class="text-sm font-medium text-black flex items-center whitespace-nowrap">
                                    <span class="font-normal text-xs text-gray-500/80 mr-1.5">{{ item.quantity }} шт. ×</span>
                                    {{ item.final_price|floatformat:0|default:'0'|intcomma }} ₽
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-sm text-gray-500 italic text-center py-2">Товары отсутствуют</p>
                        {% endfor %}
                    </div>

                    <!-- Информационная панель (внизу) -->
                    <div class="mt-6 border border-gray-100 rounded-2xl p-4 bg-white shadow-sm tracking-wide">
                        <div class="flex flex-col cursor-default gap-3">
    
                            <!-- Ряд 1: Дата и Причина -->
                            <div class="flex flex-wrap gap-2 text-[13px]">
                                <!-- Дата -->
                                <div class="group inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-50 text-gray-800 border border-gray-100 hover:shadow transition-all duration-200">
                                    <svg class="w-[17px] h-[17px] text-gray-400/65 group-hover:text-blue-600 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <rect x="4" y="6" width="16" height="15" rx="2"/><path d="M4 10h16"/><path d="M8 3v3m8-3v3"/>
                                    </svg>
                                    <span class="font-normal">{{ return_request.created_at|date:"d.m.Y" }}</span>
                                </div>
                                
                                <!-- Причина -->
                                <div class="group inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 text-gray-800 border border-gray-100 hover:shadow transition-all duration-200">
                                    <svg class="w-4 h-4 mb-0.5 text-gray-400/80 mt-0.5 flex-shrink-0 group-hover:text-blue-600 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="font-normal mb-[1px]">{{ return_request.get_reason_display }}</span>
                                </div>
                            </div>

                            <!-- Ряд 2: Комментарий -->
                            <div class="group flex items-start gap-2 p-2.5 rounded-lg border border-dashed border-gray-200 bg-gray-50/50 hover:shadow transition-all duration-200">
                                <svg class="w-4 h-4 text-gray-400/70 flex-shrink-0 group-hover:text-blue-600 transition-colors duration-200" fill="none" stroke="currentColor" stroke-width="2.1" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 0 1-4.255-.95L3 20l1.395-3.72C3.512 15.042 3 13 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[13px] text-gray-800 font-normal leading-snug break-words">
                                        {{ return_request.details|default:"Комментарий не указан" }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Разделитель -->
                        <div class="my-3 border-t border-gray-100"></div>

                        <!-- Нижняя часть: Статус и Файл -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-[13px] text-gray-600 font-normal">Статус:</span>
                                    {% include 'profile/components/status_badge.html' with status=return_request.status text=return_request.get_status_display %}
                            </div>
                            
                            {% if return_request.file %}
                                <a href="{{ return_request.file.url }}" target="_blank" class="flex items-center gap-1.5 text-[13px] font-normal text-blue-700 hover:text-blue-800 transition-colors px-2 py-1 rounded-md hover:bg-blue-50">
                                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                    </svg>
                                    Скачать заявление
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>